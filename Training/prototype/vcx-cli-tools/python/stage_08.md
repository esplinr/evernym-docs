
# Building VCX CLI Tools - Proof Request Issuance

Proof Requests, also known as *proofs*, are generated by a json data structure with the proof specifations desired by the Requester.


## Step 1 : Load Proof Request Template

In the previous Lesson, we created a file with the Proof Request attributes and restrictions named 'employee-proof-template.json'. Using this data, we will create the Proof Request.

```python
proof_data_file = "./data/"+proof_name+"-proof-definition.json"
with open(proof_data_file,'r') as fh:
    proof_data = json.loads(fh.read())
```

## Creating the Proof Request

The Proof Request is created from the proof_data, which we imported from the 'proof-definition' 

```python
proof = await Proof.create(proof_data['source_id'],proof_data['name'], proof_data['requested_attrs'])
```

## Step 2 : Offering the Proof Request

In order to issue the Proof Request, you must send it to a Connection. In the following code example, we will re-constitute a Connection by deserializing it from a file on disk from a previously created Connection.

```python
connection_data_file = "./data/"+"connection-"+connection_name+".json" 
with open(connection_data_file,'r') as fr:
    serialized_connection = json.loads(fr.read())
connection = await Connection.deserialize(serialized_connection)
await connection.update_state() 
await proof.request_proof(connection)
```

## Step 3 : Polling for Acceptance of Request

As in multiple cases before, the state of the request must be updated and polled from the Agency Server, which handles all Credential exchange and Connection requests in a queue.

```python
while proof_state != State.Accepted:
    await proof.update_state()
    proof_state = await proof.get_state()
```

## Step 4 : Validation of Proof Request

proof.get_proof(connection) will actuall retrieve the proof from the requested connection. The returned Proof will be a data structure that will have the values requested, from the requested Issuers, or any Issuers the requested party determines they wish to send. Once the proof is *received* you can validate the State of the ProofState by checking against the parameteres issued in the Proof Request. This is done automatically in the Agency Server, and the ProofState will reflect that check. Below is code that handles the result of the returned Proof, and prints out a message to the console to inform you what state the Proof has been returned in.

```python
await proof.get_proof(connection)
# check Proof State to determine Verifiability
print("Check if proof is valid")
if proof.proof_state == ProofState.Verified:
    print("proof is verified!!")
    print("Congratulations! You have successfully completed this Lab!")
else:
    print("could not verify proof :(")
    print("Something went wrong verifying this Proof. Try again to complete this Lab!")
```

## requestProof Function Code

This function is the the completed requestProof code.

```python
async def requestProof(proof_name, connection_name):
    print("You called {} with parameters {}".format(inspect.stack()[0][3], ', '.join(['{}={}'.format(k,v) for k,v in locals().items()])))
    await _initialize()
    with open('./data/{}-proof-definition.json'.format(proof_name),'r') as fh:
        proof_template = json.load(fh)
    with open('./data/{}-connection.json'.format(connection_name),'r') as fh:
        connection_data = json.load(fh)
    connection = await Connection.deserialize(connection_data)
    print('sending proof request for: {}'.format(json.dumps(proof_template)))
    proof = await Proof.create(proof_template['sourceId'],
                               proof_template['name'], 
                               proof_template['attrs'],
                               proof_template['revocationInterval'])
    await proof.request_proof(connection)    
    await proof.update_state()
    state = await proof.get_state()
    while state != State.Accepted:
        sleep(2)
        print('The state of the proof request is {}'.format(state))
        await proof.update_state()
        state = await proof.get_state()
    print('The state of the proof request is {}. Checking validity of proof'.format(state))
    returned_proof = await proof.get_proof(connection) 
    if _verifyClaims(returned_proof, proof_template):
        print("All restricted claims in proof are verified!!")
    else:
        print("Could NOT verify all restricted claims in proof :(")
    with open('./data/{}-proof.json'.format(connection_name),'w') as fh:
        fh.write(json.dumps(returned_proof, sort_keys=True, indent=4, separators=(',', ': ')))
    print("For proof details, look in {}".format('./data/{}-proof.json'.format(connection_name)))
    return

```

## CLI Use Example

```bash
    python3 requestProof employee nzeman
```