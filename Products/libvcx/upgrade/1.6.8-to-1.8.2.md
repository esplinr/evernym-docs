### Prerequisites

You will need to install these specific versions of the following packages.

* `libindy` 1.8.2
* `libvcx` 0.2.41140129-e0d1c6e
* `libnullpay` 1.8.2 _or_ `libsovtoken` 0.9.7

```bash
sudo dpkg -i libindy_1.8.2_amd64.deb
sudo dpkg -i libnullpay_1.8.2_amd64.deb
sudo dpkg -i libsovtoken_0.9.7_amd64.deb
sudo dpkg -i libvcx_0.2.41140129-e0d1c6e_amd64.deb
sudo apt-get install -f
```

If you are using the Python or Node.js wrapper, download the latest wrapper from the portal and replace the old wrapper with it.

### Configuration Updates

The `vcx-config.json` file data, which is generated by `provision_agent_keys.py`, has some new mandatory keys. Below is the new structure, with additional keys from the 1.6.8 version noted.

#### `vcx-config.json`

There are 2 new data keys needed in the `vcx-config.json` file.

``` javascript
"protocol_type":"1.0"
"payment_method":"sov"
```
Add as shown:

``` javascript
{
  "agency_did": "UNM2cmvMVoWpk6r3pG5FAq",
  "agency_endpoint": "https://eas01.pps.evernym.com",
  "agency_verkey": "FvA7e4DuD2f9kYHq6B3n7hE7NQvmpgeFRrox3ELKv9vX",
  "genesis_path": "/vagrant/config/genesis.txn",
  "institution_did": "SsjVP9fL1FaWj7vVsmS2nj",
  "institution_logo_url": "https://robohash.org/lolza",
  "institution_name": "NAME",
  "institution_verkey": "F6x7gb1RinB9sCPCcsbJnu2MUK1KtExnkamUrCasxaEa",
  "remote_to_sdk_did": "AS1fw1sKniP9q1iYcHUAqb",
  "remote_to_sdk_verkey": "6997d9526WSFTPbW48pb4dovReWiJQY8SCAhoPD6RBYe",
  "sdk_to_remote_did": "H5XKcnTsgS4riwb6t2WjEV",
  "sdk_to_remote_verkey": "9mFtER4v5JHbE2U62iFXkGj46FvJJJagmw3ZSwpUwcJL",
  "wallet_key": "12345",
  "wallet_name": "LIBVCX_SDK_WALLET",
  //additional keys from 1.68 -> 1.8.2 :
  "protocol_type": "1.0",
  "payment_method":"sov"
}
```

### Initialization Updates
There are some new imports and libraries needed for the functioning of Libindy 1.8.2 that were not required in 1.6.8.

#### import `cdll`

Import `cdll` (or `ffi` for nodejs) from `ctypes`.

**_Python_**

```python
from ctypes import cdll
```

**_JavaScript_**

```javascript
var ffi=require('ffi');
```

#### `libsovtoken`

Before `vcx_init()` is called, you will need to add `libsovtoken.so` and initialize it.

**_Python_**

```python
async def _initialize():
    lib = cdll.LoadLibrary('/usr/lib/libsovtoken.so')
    lib.sovtoken_init()
    await vcx_init(configPath)
    return
```

**_JavaScript_**

```javascript
async function _initialize(){
    const myffi = ffi.Library('/usr/lib/libsovtoken.so', {sovtoken_init: ['void', []]});
    await myffi.sovtoken_init();
    await vcx.initVcx(config);
}
```

### Connections

Connection data structures have changed significantly since version 1.6.8. The new data structure requirements for `connection.connect(options)` are as follows (`connectionPhoneNumber` represents the SMS number of the intended recipient):

**_Python_**

1. SMS :

```python
connection_data = {
    'id': name,
    'connection_type': 'SMS',
    'phone': phone_number,
    'use_public_did': False
}
connection_args = json.dumps(connection_data)
await connection.connect(connection_args)
```

2. QR :

```python
connection_data = {
     'id': name,
     'connection_type': 'QR',
     'use_public_did': False
 }
 connection_args = json.dumps(connection_data)
 await connection.connect(connection_args)
```

**_JavaScript_**

1. SMS :

```javascript
connectionData=
{
  "id":name,
  "connection_type":"SMS",
  "phone":String(phonenumber),
  "use_public_did":false
}
connectionArgs = {data: JSON.stringify(connectionData)};
await connection.connect(connectionArgs);
```

2. QR :

```javascript
connectionData=
  {
    "id":name,
    "connection_type":"QR",
    "use_public_did":false
  }
  connectionArgs = {data: JSON.stringify(connectionData)};
  await connection.connect(connectionArgs);
```

### Schema

Writing a schema to the ledger should require no code changes from 1.6.8 to 1.8.2, however the structure of the JSON passed into the `Schema.create` function has been modified in the JavaScript wrapper:

**_JavaScript_**

```javascript
{
  "data":
  {
    "attrNames":["attr1","attr2"],
    "version":"11.12",
    "name":"Schema1"
  },
  "sourceId":"testSchema1",
  "paymentHandle":0
}
```

### Credential Definition

Usage of Credential Definitions has changed significantly from 1.6.8 to 1.8.2. Instead of using a Credential Definition ID to reference a particular Credential Definition, a handle to the entire Credential Definition object will be used. The Credential Definition object should be serialized and saved so the handle can be retrieved from it for reuse.

Libindy version 1.6.8 Credential Definition Creation (**the old way**):

**_Python_**

```python
credential_definition = await CredentialDef.create(source_id, name, schema_id, payment_handle)
cred_def = await CredentialDef.create("CredDefId",
                                      credential_name,
                                      schema_id,
                                      0)
cred_def_id = await cred_def.get_cred_def_id()
```

**_JavaScript_**

```javascript
// credential_definition = await CredentialDef.create(name, payment_handle,
// revocationDetails, schema_id, sourceID)
cred_def = await CredentialDef.create({name:"CredDefId",
                                       paymentHandle:0,
                                       revocation:false,
                                       schemaId:schemaId,
                                       sourceId:sourceId});
cred_def_id = await cred_def.get_cred_def_id();
```

Libindy version 1.8.2 Credential Definition Creation (**the new way**):

**_Python_**

```python
credential_definition = await CredentialDef.create('UUID',
                                                   'CredentialName',
                                                   schema_id,
                                                   0)
credential_definition_handle = credential_definition.handle
# Serialize credential definition to disk for later reuse (for example)
serialized_cred_def = await cred_def.serialize()
with open(credDefFileName, 'w') as fh:
  json.dump(serialized_cred_def, fh)
```

**_JavaScript_**

```javascript
let schema_data = await fs.readJson(`./data/${schema_name}-schema.json`);
const data = {
  name: 'DriversLicense',
  paymentHandle: 0,
  revocation: false,
  revocationDetails: {
      tailsFile: 'tails.txt',
  },
  schemaId: schema_data.schemaId,
  sourceId: 'DL2001'
};
let credentialDef = await CredentialDef.create(data);
let ser_CredDef = await credentialDef.serialize();
await fs.writeJson(`./data/${schema_name}-credential-definition.json`,ser_CredDef);
```

### Credential Creation and Issuance

As stated above, the Credential Definition handle is the new identifier for a Credential Definition. If your agent has exited and has been restarted, the Credential Definition object must be reconstituted from its serialization, and a new handle obtained to the object. The old handle will not be valid if your agent is restarted.

Libindy version 1.6.8 (**the old way**):

**_Python_**

```python
credential = await IssuerCredential.create(cred_def['data']['source_id'],
                                           cred_data,
                                           cred_def['data']['id'],
                                           credentialName,
                                           '0')
```

**_JavaScript_**

```javascript
credential = await IssuerCredential.create(cred_def['data']['source_id'],
                                           cred_data,
                                           cred_def['data']['id'],
                                           credentialName,
                                           '0');
```

Libindy version 1.8.2 (**the new way**):

**_Python_**

```python
# If necessary, open saved serialized credential definition, deserialize it,
# and get a handle to it
with open(credDefFileName, 'r') as fh:
  serialized_cred_def = json.load(fh)
cred_def = await CredentialDef.deserialize(serialized_cred_def)
cred_def_handle = cred_def.handle
# create Credential object IssuerCredential.create(source_id, attrs,
# cred_def_handle, name, price)
credential = await IssuerCredential.create('alice_degree',
                                           credAttributes,
                                           cred_def_handle,
                                           'cred',
                                           '0')
```

**_JavaScript_**

```javascript
// If necessary, open saved serialized credential definition, deserialize it,
// and get a handle to it
let cred_def = await fs.readJson(`./data/${schema_name}-credential-definition.json`);
let cred_def_deserialzed  = await CredentialDef.deserialize(cred_def);
cred_def_handle = await cred_def_deserialzed.handle;
// create Credential object IssuerCredential.create(source_id, attrs,
// cred_def_handle, name, price)
 let credential = await IssuerCredential.create({sourceId:cred_def.sourceId,
                                                credDefHandle: cred_def_handle,
                                                attr: cred_def.attrs,
                                                credentialName:cred_def.name,
                                                price: '0'})
```

### Data Share Request Templates

Libindy version 1.8.2 allows for complex data share request templates, in which you can specify the exact parameters you require for a Proof.

Example of a complex data share request template:

```javascript
{
  "requested_attrs" : [
    {
      "name": "age",
      "restrictions":
      [
        {
          "schema_id": "6XFh8yBzrpJQmNyZzgoTqB:2:schema_name:0.0.11",
          "schema_name":"Faber Student Info",
          "schema_version":"1.0",
          "schema_issuer_did":"6XFh8yBzrpJQmNyZzgoTqB",
          "issuer_did":"8XFh8yBzrpJQmNyZzgoTqB",
          "cred_def_id": "8XFh8yBzrpJQmNyZzgoTqB:3:CL:1766"
        },
        {
          "schema_id": "5XFh8yBzrpJQmNyZzgoTqB:2:schema_name:0.0.11",
          "schema_name":"BYU Student Info",
          "schema_version":"1.0",
          "schema_issuer_did":"5XFh8yBzrpJQmNyZzgoTqB",
          "issuer_did":"66Fh8yBzrpJQmNyZzgoTqB",
          "cred_def_id": "66Fh8yBzrpJQmNyZzgoTqB:3:CL:1766"
        }
      ]
    }
  ]
}
```

### Data Share Request

In Libindy version 1.8.2, a `revocation_interval` is required, which can be left empty for now (until revocation is implemented).

Libindy version 1.6.8 (**the old way**):

**_Python_**

```python
proof = await Proof.create('proof_uuid','proof_from_alice', proofTemplate)
```

**_JavaScript_**

```javascript
let proof = await Proof.create('proof_uuid','proof_from_alice', proofTemplate);
```

Libindy version 1.8.2 (**the new way**):

**_Python_**

```python
proof = await Proof.create('proof_uuid','proof_from_alice', proofTemplate, {})
```

**_JavaScript_**

```javascript
proof = await Proof.create('proof_uuid','proof_from_alice', proofTemplate, {});
```
